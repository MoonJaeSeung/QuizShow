<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="utf-8">
    <title>Guess the Word</title>
    <style>

        @keyframes shake {
            0% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        .shake-animation {
            animation: shake 0.5s infinite;
        }

        .container{
            display: block;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;

        }


        #wordContainer {
            margin-top: 50px;
        }

        #guessForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        label {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 10px;
        }

        input[type="text"] {
            padding: 5px;
            font-size: 16px;
            border-radius: 3px;
            border: 1px solid #ccc;
            width: 200px;
        }

        #guessForm button[type="submit"] {
            margin-top: 10px;
        }

        button[type="submit"]:hover {
            background-color: #45a049;
        }

        #errorContainer {
            margin-top: 20px;
            font-size: 16px;
        }

        #completionMessage {
            font-size: 20px;
            font-weight: bold;
            margin-top: 50px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<th:block layout:fragment="content">
    <div class="container">
        <div id="timer" style="font-size: 30px; font-weight: bold;"></div>
        <br>

        <div id="wordContainer">
            <!-- The JavaScript code will generate the forms here -->
        </div>

        <!-- This is a hidden field for storing the current word's index -->
        <input type="hidden" id="currentWordIndex" value="0">
        <!-- A div for displaying error messages -->
        <div id="errorContainer" style="color: red;"></div>

        <a href="/game"> 다시 하기</a>
        <a href="/record?value=1">기록 확인</a>
        <th:block layout:fragment="script">
            <script th:inline="javascript">
                /*<![CDATA[*/
                var words = /*[[${words}]]*/ []; // get the words from the Thymeleaf model
                var correctGuesses = 0; // count of correct guesses
                var incorrectGuessesForCurrentWord = 0; // count of incorrect guesses for the current word
                var nick = /*[[${nick}]]*/ '';
                // Function to shuffle the words array
                function shuffleArray(array) {
                    for (var i = array.length - 1; i > 0; i--) {
                        var j = Math.floor(Math.random() * (i + 1));
                        var temp = array[i];
                        array[i] = array[j];
                        array[j] = temp;
                    }
                    return array;
                }

                function generateForm() {
                    // get the current word index
                    var currentWordIndex = parseInt($('#currentWordIndex').val());

                    if (currentWordIndex < words.length) {
                        // create the HTML for the form
                        var word = words[currentWordIndex];
                        var revealedPart = word.fullWord.substring(0, 2); // Get the first two letters
                        var hiddenPart = word.fullWord.substring(2); // Get the rest of the word

                        var formHtml = '<form id="guessForm">' +
                            '<label for="guess">' + revealedPart + ' __</label><br>' +
                            '<input type="hidden" id="wordId" value="' + word.id + '">' +
                            '<input type="hidden" id="hiddenPart" value="' + hiddenPart + '">' +
                            '<input type="text" id="guess" required><br>' +
                            '<button class="game-button" type="submit">E n t e r</button>' +
                            '</form>';

                        // set the form HTML in the wordContainer
                        $('#wordContainer').html(formHtml);
                        $('#errorContainer').html(''); // clear any existing error messages

                        // attach the form submit event handler
                        $('#guessForm').on('submit', function (event) {
                            event.preventDefault(); // prevent the form from being submitted normally

                            // get the user's guess
                            var guess = $('#guess').val();

                            // get the hidden part
                            var hiddenPart = $('#hiddenPart').val();

                            // check if the guess matches the hidden part
                            if (guess.toLowerCase() === hiddenPart.toLowerCase()) {
                                // if the guess is correct, increment the current word index and correctGuesses
                                $('#currentWordIndex').val(currentWordIndex + 1);
                                correctGuesses++;
                                incorrectGuessesForCurrentWord = 0; // reset the count of incorrect guesses
                                generateForm(); // generate the next form
                            } else {
                                incorrectGuessesForCurrentWord++;
                                if (incorrectGuessesForCurrentWord >= 2) {
                                    // if the user has guessed incorrectly twice, move to the next word
                                    $('#currentWordIndex').val(currentWordIndex + 1);
                                    incorrectGuessesForCurrentWord = 0; // reset the count of incorrect guesses
                                    generateForm(); // generate the next form
                                } else {
                                    // if the guess is incorrect, show an error message, clear the input, and apply shake animation
                                    $('#errorContainer').html('한번 더 틀리면 기회 없어!');
                                    var guessInput = $('#guess');
                                    guessInput.addClass('shake-animation');
                                    setTimeout(function() {
                                        guessInput.removeClass('shake-animation');
                                    }, 300);
                                    guessInput.val('');
                                }
                            }
                        });
                    }else {
                        // no more words, display a completion message
                        $('#wordContainer').html(nick + '<p id="completionMessage">' + correctGuesses + '개 정답!</p>');
                    }
                }



                var timeLimit = 3; // time limit in seconds

                // start the countdown when the page loads
                var countdown = setTimeout(function () {
                    endGame();
                }, timeLimit * 1000);

                var timeLeft = timeLimit;

                function updateTimer() {
                    $('#timer').html('남은 시간: ' + timeLeft + '초');
                    if (timeLeft <= 0) {
                        endGame();
                    } else {
                        timeLeft--;
                    }
                }

                var countdown = setInterval(updateTimer, 1000);

                function endGame() {

                    clearInterval(countdown);
                    $('#errorContainer').html('');
                    $('#timer').html('종료');
                    $('#guessForm').off('submit');

                    // clear any existing forms
                    $('#wordContainer').html('');

                    // display a message indicating that the game has ended
                    var completionMessage = '<p id="completionMessage">' + nick + '님, 시간이 끝났습니다! <br>' +
                        correctGuesses + '개 정답!</p>';

                    $('#wordContainer').append(completionMessage);

                    //기록 삽입
                    var recordDto={
                        nick:nick,
                        score:correctGuesses,
                        game:1
                    };

                    $.ajax({
                        url:'/record/add',
                        type: 'POST',
                        contentType: 'application/json',
                        data : JSON.stringify(recordDto),
                        success: function(){
                            console.log("성공");
                        },
                        error:function(){
                            console.log('Failed to add record');
                        }
                    })
                }

                function updateTimer() {
                    $('#timer').html('남은 시간: ' + timeLeft + '초');

                    if (timeLeft <= 0) {
                        endGame();
                    } else if (timeLeft === 5) {
                        $('#timer').addClass('shake-animation');
                    } else if (timeLeft < 2) {
                        $('#timer').removeClass('shake-animation');
                    }

                    timeLeft--;
                }

                // Shuffle the words array
                words = shuffleArray(words);

                // generate the first form when the page loads
                $(document).ready(function () {
                    console.log(nick);
                    updateTimer();
                    generateForm();
                });
                /*]]>*/
            </script>
        </th:block>
    </div>
</th:block>
</body>
</html>
